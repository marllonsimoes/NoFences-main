# Summary of Changes and Troubleshooting for NoFences WiX Installer

This document summarizes the changes made and the troubleshooting steps taken to resolve build errors in the NoFences WiX installer project, specifically focusing on the transition from a `.vdproj` installer to a WiX v4-based installer.

## Initial Problem: WiX SDK Resolution

**Error:** `Could not resolve SDK "Microsoft.NET.Sdk.Wix".`

**Approach:**
1.  Initially, attempted to add `WixToolset.Sdk` as a `PackageReference`. This was incorrect.
2.  Corrected the `Sdk` attribute in `NoFences.Installer.Wix.wixproj` from `Microsoft.NET.Sdk.Wix` to `WixToolset.Sdk/4.0.0`. This resolved the SDK resolution error.

## WiX v4 Schema Validation Errors

**Error:** `WIX0199: The Wix element has an incorrect namespace...`
**Fix:** Updated the `xmlns` attribute in `Product.wxs` to `http://wixtoolset.org/schemas/v4/wxs`.

**Error:** `WIX0005: The Wix element contains an unexpected child element 'Product'.` (and similar errors for `ProductRef` and `Product` within `Fragment`).
**Approach:**
1.  Initially, attempted to wrap `Product` in a `Fragment` or use `ProductRef`, which were incorrect for WiX v4.
2.  **Realization:** In WiX v4 with `WixToolset.Sdk`, the `<Package>` element is the direct child of `<Wix>` in the `.wxs` file, not `<Product>`. The `Product` element is implicitly handled or configured via the SDK.
3.  **Fix:** Refactored `Product.wxs` to place the `<Package>` element directly under `<Wix>`, and moved all installer-specific elements (MajorUpgrade, MediaTemplate, Feature, CustomActions, etc.) as children of `Package`.
4.  Removed the `WixProduct` item and `WixPackage...` properties from `NoFences.Installer.Wix.wixproj` as they became redundant.

## Package Element Attribute Errors

**Error:** `WIX0004: The Package element contains an unexpected attribute 'Id'.` (and similar for `InstallScope`).
**Fix:** Removed the `Id` and `InstallScope` attributes directly from the `Package` element in `Product.wxs`. These are likely handled implicitly or configured elsewhere by the SDK.

## Component and Custom Action Errors

**Error:** `WIX0005: The Package element contains an unexpected child element 'Condition'.`
**Fix:** Removed the `PropertyRef` and `Condition` elements related to .NET Framework from `Product.wxs`. The .NET Framework prerequisite is expected to be handled by the `TargetFramework` in the `.wixproj` or a specific WiX extension.

**Error:** `WIX0004: The RegistryKey element contains an unexpected attribute 'Action'.`
**Fix:** Removed the `Action` attribute from `RegistryKey` elements. WiX v4 handles registry key creation and removal implicitly.

**Error:** `WIX0230: The Component/@Guid attribute's value '*' is not valid...`
**Fix:** Provided an explicit GUID (`A1B2C3D4-E5F6-7890-1234-567890ABCDEF`) for the `Component` managing registry entries.

**Error:** `WIX0400: The Custom element contains illegal inner text...`
**Fix:** Moved the conditions for `Custom` actions from inner text to the `Condition` attribute of the `Custom` element.

**Error:** `WIX0267: Found orphaned Component 'RegistryEntries'.`
**Fix:** Moved the `RegistryEntries` `Component` into a `ComponentGroup` named `RegistryComponents` within a new `Fragment`, and added a `ComponentGroupRef` to `RegistryComponents` within the `ProductFeature`.

## Harvesting Errors (WIX0094)

**Error:** `WIX0094: The identifier 'WixComponentGroup:***_Project' could not be found.`
**Approach:** This error indicated that the `ComponentGroup` definitions generated by `HeatDirectory` were not being found by the linker.

**Troubleshooting Steps:**
1.  **Initial attempt:** Added `WixSource` items within an `AfterHarvest` target to explicitly include generated `.wxs` files. This did not resolve the issue.
2.  **Isolation with `DummyComponent`:** Created a dummy `ComponentGroup` to verify the `ComponentGroupRef` mechanism. This confirmed the mechanism works when the `ComponentGroup` is properly defined and included.
3.  **`HeatDirectory` task not found (MSB4036):** Discovered that `HeatDirectory` is part of `WixToolset.Heat` NuGet package in WiX v4.
    *   **Fix:** Added `PackageReference` for `WixToolset.Heat` to `NoFences.Installer.Wix.wixproj`.
    *   **Fix:** Replaced `HeatDirectory` tasks with `HarvestDirectory` item groups, which is the idiomatic way to harvest with `WixToolset.Sdk`.
4.  **`HarvestDirectory` skipping (no inputs):** The `HarvestDirectory` targets were being skipped because they had no inputs. This indicated that the `HarvestDirectory` items were not being correctly passed to the SDK's harvesting process.
    *   **Fix:** Added `BuildDependsOn="Harvest"` to a `PropertyGroup` in `NoFences.Installer.Wix.wixproj` to ensure the SDK's built-in `Harvest` target runs.
5.  **Incorrect paths for harvesting:** Identified that the paths for harvesting (e.g., `..\..\bin\net481`) likely had an incorrect `\net481` subdirectory.
    *   **Fix:** Removed `\net481` from the `Include` paths of all `HarvestDirectory` items.

**Current State:**
The project is now configured to use `HarvestDirectory` items with corrected paths, and `BuildDependsOn="Harvest"` is set to ensure the SDK's harvesting process runs. The `WIX0094` errors are expected to be resolved with these changes.

**Next Steps:**
Verify the build on GitHub Actions. If successful, the installer should now build correctly. If `WIX0094` errors persist, further investigation into the `HarvestDirectory` and `WixSource` interaction with the `WixToolset.Sdk` will be required.

## Critical Build Failure: MSBuild Project Loading Error

**Problem:** The build is failing with an `MSB4025` error, indicating a malformed XML structure in `NoFences.Installer.Wix.wixproj`.

**Error:** `MSB4025: The project file could not be loaded. The 'Target' start tag on line 49 position 4 does not match the end tag of 'replace'. Line 50, position 3.`

**Cause:** An extraneous `</replace>` tag was present in `NoFences.Installer.Wix.wixproj`, and the `AfterHarvest` target was not properly closed.

**Fix:**
1.  Removed the `</replace>` tag from `NoFences.Installer.Wix.wixproj`.
2.  Correctly closed the `AfterHarvest` target with `</Target>`.
3.  Re-added the `WixSource` items within the `AfterHarvest` target.

## New Build Failure: WiX Duplicate Symbol Errors (WIX0091)

**Problem:** The build is now failing with numerous `WIX0091` errors, indicating duplicate `Component` IDs generated during harvesting, and `heat.exe` warnings (HEAT5151, HEAT5150) related to loading assemblies and DLLs.

**Errors:** `WIX0091: Duplicate symbol 'Component:cmp...' referenced by ... This typically means that an Id is duplicated. Ensure all your identifiers of a given type (File, Component, Feature) are unique or use an access modifier to scope the identfier.`

**Cause:** `heat.exe` is generating duplicate `Component` IDs because shared dependencies (e.g., common NuGet packages or project references) are being harvested multiple times across different project output directories. When the WiX linker combines these generated `.wxs` files, it finds these duplicate IDs.

**`heat.exe` Warnings (HEAT5151, HEAT5150):**
*   `HEAT5151`: Could not harvest data from an assembly due to missing dependencies (e.g., `Microsoft.Bcl.AsyncInterfaces.dll`, `ControlzEx.dll`).
*   `HEAT5150`: Could not harvest data from a SelfReg DLL (e.g., `SQLite.Interop.dll`) due to an inability to load the file (error 193, often a bitness mismatch).

**Next Steps:**
1.  **Address `WIX0091` Duplicate Symbols using `HarvestProject`:**
    *   Remove the `HarvestDirectory` items from `NoFences.Installer.Wix.wixproj`.
    *   Add `HarvestProject` items for each of the projects (`NoFences`, `NoFencesService`, `NoFencesExtensions`) to `NoFences.Installer.Wix.wixproj`. `HarvestProject` is designed to handle project outputs and their dependencies more effectively, reducing duplicate harvesting.
    *   The `HarvestProject` item will typically reference the `.csproj` file directly.
2.  **Address `heat.exe` Warnings (HEAT5151, HEAT5150):**
    *   These warnings are often benign if the files are not meant to be assemblies or self-registering DLLs. However, if they are, it indicates missing dependencies in the build environment.
    *   For `SQLite.Interop.dll` (error 193), it often means a bitness mismatch. We might need to ensure the correct architecture (x86/x64) is targeted for the installer and the harvested components.
    *   For now, we will focus on resolving the `WIX0091` errors. If the warnings persist and cause issues, we will investigate further.
