name: NoFences CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop, 'feature/**', 'bugfix/**', 'revamp/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allow manual trigger

env:
  SOLUTION_FILE: NoFences.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: "Any CPU"

jobs:
  build-and-test:
    name: Build & Test
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper versioning

    - name: Setup .NET Framework
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE }}

    - name: Build solution
      run: msbuild ${{ env.SOLUTION_FILE }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform="${{ env.BUILD_PLATFORM }}" /m /v:minimal

    - name: Run Unit Tests (Fast)
      run: |
        dotnet test NoFences.Tests/NoFences.Tests.csproj `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --filter "Category!=Integration" `
          --logger "trx;LogFileName=test-results-unit.trx" `
          --logger "console;verbosity=detailed" `
          --no-build `
          --collect:"XPlat Code Coverage"
      continue-on-error: false

    - name: Run Integration Tests
      run: |
        dotnet test NoFences.Tests/NoFences.Tests.csproj `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --filter "Category=Integration" `
          --logger "trx;LogFileName=test-results-integration.trx" `
          --logger "console;verbosity=detailed" `
          --no-build `
          --collect:"XPlat Code Coverage"
      continue-on-error: true  # Integration tests may fail without API keys/external resources

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          **/TestResults/*.trx
          **/TestResults/*/coverage.cobertura.xml

    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/TestResults/*.trx'
        reporter: dotnet-trx
        fail-on-error: false

    - name: Generate Code Coverage Report
      if: always()
      run: |
        dotnet tool install -g dotnet-reportgenerator-globaltool
        reportgenerator `
          -reports:"**/TestResults/*/coverage.cobertura.xml" `
          -targetdir:"coverage-report" `
          -reporttypes:"Html;Cobertura;MarkdownSummaryGithub" `
          -assemblyfilters:"+NoFencesDataLayer;+NoFencesCore;+NoFences;-NoFences.Tests"

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage-report/

    - name: Add Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request' && always()
      with:
        recreate: true
        path: coverage-report/SummaryGithub.md

    - name: Check Code Coverage Threshold
      if: always()
      run: |
        # Parse coverage percentage from Cobertura XML
        [xml]$coverage = Get-Content "coverage-report/Cobertura.xml" -ErrorAction SilentlyContinue
        if ($coverage) {
          $lineRate = [double]$coverage.coverage.'line-rate' * 100
          $branchRate = [double]$coverage.coverage.'branch-rate' * 100
          
          Write-Host "Line Coverage: $lineRate%"
          Write-Host "Branch Coverage: $branchRate%"
          
          if ($lineRate -lt 70.0) {
            Write-Warning "Line coverage ($lineRate%) is below 70% threshold"
          }
          if ($branchRate -lt 60.0) {
            Write-Warning "Branch coverage ($branchRate%) is below 60% threshold"
          }
        }

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nofences-build-${{ github.sha }}
        path: |
          NoFences/bin/${{ env.BUILD_CONFIGURATION }}/
          !NoFences/bin/${{ env.BUILD_CONFIGURATION }}/**/*.pdb
          !NoFences/bin/${{ env.BUILD_CONFIGURATION }}/**/*.xml
        retention-days: 14

  code-quality:
    name: Code Quality Analysis
    runs-on: windows-latest
    needs: build-and-test

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'

    - name: Run Code Analysis (Optional - requires Roslyn analyzers)
      run: |
        msbuild ${{ env.SOLUTION_FILE }} /t:Rebuild /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:RunCodeAnalysis=true /v:minimal
      continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: windows-latest
    needs: build-and-test
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'NoFences'
        path: '.'
        format: 'HTML'
        out: 'dependency-check-report'
      continue-on-error: true

    - name: Upload Dependency Check Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-check-report
        path: dependency-check-report/

  release:
    name: Create Release (on tags)
    runs-on: windows-latest
    needs: [build-and-test, code-quality, security-scan]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE }}

    - name: Build Release
      run: msbuild ${{ env.SOLUTION_FILE }} /p:Configuration=Release /p:Platform="${{ env.BUILD_PLATFORM }}" /m

    - name: Package Release
      run: |
        $version = "${{ github.ref_name }}" -replace '^v',''
        Compress-Archive -Path "NoFences/bin/Release/*" -DestinationPath "NoFences-$version.zip"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: NoFences-*.zip
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, security-scan]
    if: always() && (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))

    steps:
    - name: Check Job Status
      run: |
        if [ "${{ needs.build-and-test.result }}" == "success" ]; then
          echo "✅ Build and tests passed!"
        else
          echo "❌ Build or tests failed!"
          exit 1
        fi
