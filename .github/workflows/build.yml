name: NoFences Build, Test & Release

on:
  push:
    branches: [ main, master, develop, 'feature/**', 'bugfix/**', 'revamp/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allow manual trigger

env:
  SOLUTION_FILE: NoFences.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: "Any CPU"
  CI: true  # Required for Directory.Build.props signing logic

jobs:
  build-and-test:
    name: Build & Test
    runs-on: windows-2022

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for versioning

    - name: Determine Version
      id: version
      run: |
        # Get the current version from AssemblyInfo.cs
        $assemblyInfoPath = "NoFences\Properties\AssemblyInfo.cs"
        $content = Get-Content $assemblyInfoPath -Raw

        if ($content -match 'AssemblyVersion\("(\d+\.\d+\.\d+)\.') {
          $currentVersion = $matches[1]
          Write-Host "Current version: $currentVersion"
        } else {
          Write-Error "Could not find version in AssemblyInfo.cs"
          exit 1
        }

        # Check if this is a push to main/master (not a PR)
        $isPushToMain = "${{ github.event_name }}" -eq "push" -and ("${{ github.ref }}" -eq "refs/heads/main" -or "${{ github.ref }}" -eq "refs/heads/master")

        if ($isPushToMain) {
          # Increment patch version for main/master pushes
          $versionParts = $currentVersion.Split('.')
          $major = [int]$versionParts[0]
          $minor = [int]$versionParts[1]
          $patch = [int]$versionParts[2]
          $newVersion = "$major.$minor.$patch"

          Write-Host "New version: $newVersion"
          echo "version=$newVersion" >> $env:GITHUB_OUTPUT
          echo "should_tag=true" >> $env:GITHUB_OUTPUT
          echo "is_release=true" >> $env:GITHUB_OUTPUT
        } else {
          # Use current version for PRs and other branches
          echo "version=$currentVersion" >> $env:GITHUB_OUTPUT
          echo "should_tag=false" >> $env:GITHUB_OUTPUT
          echo "is_release=false" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh

    - name: Update AssemblyInfo Version
      if: steps.version.outputs.is_release == 'true'
      run: |
        $newVersion = "${{ steps.version.outputs.version }}"
        $assemblyInfoPath = "NoFences\Properties\AssemblyInfo.cs"

        $content = Get-Content $assemblyInfoPath -Raw
        $content = $content -replace 'AssemblyVersion\("(\d+\.\d+\.\d+)\.\d+"\)', "AssemblyVersion(""$newVersion.0"")"
        $content = $content -replace 'AssemblyFileVersion\("(\d+\.\d+\.\d+)\.\d+"\)', "AssemblyFileVersion(""$newVersion.0"")"

        Set-Content -Path $assemblyInfoPath -Value $content

        Write-Host "Updated AssemblyInfo.cs to version $newVersion.0"
      shell: pwsh

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE }}

    - name: Setup .NET SDK (for WiX)
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Set up environment for signing
      run: |
        echo "CERTIFICATE_PASSWORD=${{ secrets.CERTIFICATE_PASSWORD }}" >> $env:GITHUB_ENV

        $cert_path = "${{ runner.temp }}\signing_cert.pfx"
        [System.IO.File]::WriteAllBytes($cert_path, [System.Convert]::FromBase64String("${{ secrets.SIGNING_CERTIFICATE }}"))
        echo "CERTIFICATE_PATH=$cert_path" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Install WiX Toolset
      run: dotnet tool install --global wix

    - name: Build Solution
      run: |
        msbuild ${{ env.SOLUTION_FILE }} -t:Restore
        msbuild ${{ env.SOLUTION_FILE }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform="${{ env.BUILD_PLATFORM }}" /m /v:minimal

    - name: Setup VSTest
      uses: darenm/Setup-VSTest@v1.2

    - name: Run Unit Tests
      run: |
        vstest.console.exe "NoFences.Tests\bin\${{ env.BUILD_CONFIGURATION }}\net481\NoFences.Tests.dll" `
          /TestCaseFilter:"Category!=Integration" `
          /Logger:"trx;LogFileName=test-results-unit.trx" `
          /Logger:"console;verbosity=detailed"
      continue-on-error: false

    - name: Run Integration Tests
      run: |
        vstest.console.exe "NoFences.Tests\bin\${{ env.BUILD_CONFIGURATION }}\net481\NoFences.Tests.dll" `
          /TestCaseFilter:"Category=Integration" `
          /Logger:"trx;LogFileName=test-results-integration.trx" `
          /Logger:"console;verbosity=detailed"
      continue-on-error: true  # Integration tests may fail without API keys

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          **/*.trx

    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/*.trx'
        reporter: dotnet-trx
        fail-on-error: false

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nofences-build-${{ github.sha }}
        path: |
          NoFences/bin/${{ env.BUILD_CONFIGURATION }}/
          !NoFences/bin/${{ env.BUILD_CONFIGURATION }}/**/*.pdb
          !NoFences/bin/${{ env.BUILD_CONFIGURATION }}/**/*.xml
        retention-days: 14

    - name: Upload NoFences Installer
      uses: actions/upload-artifact@v4
      with:
        name: NoFences-Installer
        path: NoFences.Installer\bin\Release\NoFences.msi

    - name: Upload NoFences Bootstrap
      uses: actions/upload-artifact@v4
      with:
        name: NoFences-Installer-bootstrap
        path: NoFences.Installer\bin\Release\NoFences.bootstrap.exe

  code-quality:
    name: Code Quality Analysis
    runs-on: windows-latest
    needs: build-and-test

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE }}

    - name: Run Code Analysis
      run: |
        msbuild ${{ env.SOLUTION_FILE }} /t:Rebuild /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:RunCodeAnalysis=true /v:minimal
      continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: windows-latest
    needs: build-and-test
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'NoFences'
        path: '.'
        format: 'HTML'
        out: 'dependency-check-report'
      continue-on-error: true

    - name: Upload Dependency Check Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-check-report
        path: dependency-check-report/

  release:
    name: Create Release
    runs-on: windows-2022
    needs: [build-and-test, code-quality, security-scan]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Get Version from build-and-test job
      id: version
      run: |
        # Re-determine version (same logic as build job)
        $assemblyInfoPath = "NoFences\Properties\AssemblyInfo.cs"
        $content = Get-Content $assemblyInfoPath -Raw

        if ($content -match 'AssemblyVersion\("(\d+\.\d+\.\d+)\.') {
          $currentVersion = $matches[1]
          $versionParts = $currentVersion.Split('.')
          $major = [int]$versionParts[0]
          $minor = [int]$versionParts[1]
          $patch = [int]$versionParts[2] + 1
          $newVersion = "$major.$minor.$patch"

          Write-Host "Release version: $newVersion"
          echo "version=$newVersion" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh

    - name: Download Installer Artifacts
      uses: actions/download-artifact@v4
      with:
        name: NoFences-Installer
        path: artifacts/installer

    - name: Download Bootstrap Artifacts
      uses: actions/download-artifact@v4
      with:
        name: NoFences-Installer-bootstrap
        path: artifacts/bootstrap

    - name: Commit Version Bump
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        git add NoFences\Properties\AssemblyInfo.cs
        git commit -m "chore: bump version to ${{ steps.version.outputs.version }}" || echo "No changes to commit"

        git push origin ${{ github.ref_name }}
      shell: pwsh

    - name: Create Git Tag
      run: |
        $version = "v${{ steps.version.outputs.version }}"

        git tag -a $version -m "Release $version"
        git push origin $version

        Write-Host "Created and pushed tag: $version"
      shell: pwsh

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: NoFences v${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        files: |
          artifacts/installer/NoFences.msi
          artifacts/bootstrap/NoFences.bootstrap.exe
        body: |
          ## NoFences v${{ steps.version.outputs.version }}

          ### Installation
          Download and run `NoFences.bootstrap.exe` to install NoFences with automatic .NET Framework 4.8.1 prerequisites.

          ### Changes
          - Auto-generated release from build pipeline
          - See commit history for details

          ### Files
          - `NoFences.bootstrap.exe` - Bootstrapper with .NET Framework installer (recommended)
          - `NoFences.msi` - MSI installer (requires .NET Framework 4.8.1 pre-installed)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, security-scan]
    if: always() && (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))

    steps:
    - name: Check Job Status
      run: |
        if [ "${{ needs.build-and-test.result }}" == "success" ]; then
          echo "✅ Build and tests passed!"
        else
          echo "❌ Build or tests failed!"
          exit 1
        fi
